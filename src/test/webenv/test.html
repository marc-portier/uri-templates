<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="./js/jquery-1.5.2.min.js"></script>
  <link rel="stylesheet" href="./qunit/qunit.css" type="text/css" media="screen" />
  <script type="text/javascript" src="./qunit/qunit.js"></script>
  <script type="text/javascript" src="../../main/js/uritemplates.js"></script>

  <script>
    $(document).ready( function() {
    
// pure parsing and object instantiation
module("Uri template parsing");

test("parse templates", function() {
    var tees = [
        "",
        "{x}",
        "{x.y}",
        "{+x}",
        "{+x*=help,y}",
        "{x+}",
        "{x:10}",
        "{x^-3=def}",
        "{a,b}",
        "{+a,b}",
        "{/a=yes,b=no}",
        "{?a:-2,b*}",
        "{.a,b}",
        "{;a,b^4}",
        "abc",
        "a{b}c",
        "{this}and{that}or{more}",
        "half{open",
        "half}close",
        "more{normal}open{half{whole}",
        "{whole}half}close{normal}more",
        "more{normal}{en{clos}ed}{normal}more"
    ];
    var cnt = tees.length;

    expect(cnt);
    
    for (var i = 0; i < cnt; i++) {
        try {
            var parsed = $.uritemplate(tees[i]);
            ok (parsed != null, "completed parsing of '" + tees[i] + "'");
        } catch (err) {
            var errStr = QUnit.jsDump.parse(err);
            ok (false, "error in parsing of '" + tees[i] + "' : " + errStr);
        }
    }
});

function assertSet(set, data) {
    
    var count = 0;
    for (pattern in set) {
        count++
    }
    expect(count);
    
    for (pattern in set) {
        var template = $.uritemplate(pattern);
        var result = template.expand(data);
        var expected = set[pattern];

        equals(result, expected, "tested pattern: " + pattern);
    }
}

module("Samples from the spec");
test("page 5", function() {
    var context = {"query": "mycelium", "number": 100}; // no "undef"
    var testset = {
        "http://www.example.com/foo{?query,number}": "http://www.example.com/foo?query=mycelium&number=100",
        "http://www.example.com/foo{?undef,number}": "http://www.example.com/foo?number=100"
    };
    assertSet(testset, context);
});

test("table on pages 6-8", function() {
    var context = {
        "var"   : "value",
        "hello" : "Hello World!",
        "undef" : null, //explicit, but same as not mentioning it
        "empty" : "",
        "list"  : [ "val1", "val2", "val3" ],
        "keys"  : {"key1": "val1", "key2": "val2"},
        "path"  : "/foo/bar",
        "x"     : 1024,
        "y"     : 768
    }



    var testset = {
    //  Simple expansion with comma-separated values
        "{var}"           : "value",
        "{hello}"          : "Hello%20World%21",
        "{path}/here"     : "%2Ffoo%2Fbar/here",
        "{x,y}"           : "1024,768",
        "{var=default}"   : "value",
        "{undef=default}" : "default",
        "{list}"          : "val1,val2,val3",
        "{list*}"         : "val1,val2,val3",
        "{list+}"         : "list.val1,list.val2,list.val3",
        "{keys}"          : "key1,val1,key2,val2",
        "{keys*}"         : "key1,val1,key2,val2",
        "{keys+}"         : "keys.key1,val1,keys.key2,val2",

    // Reserved expansion with comma-separated values
        "{+var}"         : "value",
        "{+hello}"       : "Hello%20World!",
        "{+path}/here"   : "/foo/bar/here",
        "{+path,x}/here" : "/foo/bar,1024/here",
        "{+path}{x}/here": "/foo/bar1024/here",
        "{+empty}/here"  : "/here",
        "{+undef}/here"  : "/here",
        "{+list}"        : "val1,val2,val3",
        "{+list*}"       : "val1,val2,val3",
        "{+list+}"       : "list.val1,list.val2,list.val3",
        "{+keys}"        : "key1,val1,key2,val2",
        "{+keys*}"       : "key1,val1,key2,val2",
        "{+keys+}"       : "keys.key1,val1,keys.key2,val2",

    // Path-style parameters, semicolon-prefixed
        "{;x,y}"       : ";x=1024;y=768",
        "{;x,y,empty}" : ";x=1024;y=768;empty",
        "{;x,y,undef}" : ";x=1024;y=768",
        "{;list}"      : ";val1,val2,val3",
        "{;list*}"     : ";val1;val2;val3",
        "{;list+}"     : ";list=val1;list=val2;list=val3",
        "{;keys}"      : ";key1,val1,key2,val2",
        "{;keys*}"     : ";key1=val1;key2=val2",
        "{;keys+}"     : ";keys.key1=val1;keys.key2=val2",
        //added own
        "{;undef}"     : "",


    //  Form-style parameters, ampersand-separated
        "{?x,y}"       : "?x=1024&y=768",
        "{?x,y,empty}" : "?x=1024&y=768&empty=",
        "{?x,y,undef}" : "?x=1024&y=768",
        "{?list}"      : "?list=val1,val2,val3",
        "{?list*}"     : "?val1&val2&val3",
        "{?list+}"     : "?list=val1&list=val2&list=val3",
        "{?keys}"      : "?keys=key1,val1,key2,val2",
        "{?keys*}"     : "?key1=val1&key2=val2",
        "{?keys+}"     : "?keys.key1=val1&keys.key2=val2",
        //added own
        "{?undef}"     : "",

    //  Hierarchical path segments, slash-separated
        "{/var}"       : "/value",
        "{/var,empty}" : "/value/",
        "{/var,undef}" : "/value",
        "{/list}"      : "/val1,val2,val3",
        "{/list*}"     : "/val1/val2/val3",
        "{/list*,x}"   : "/val1/val2/val3/1024",
        "{/list+}"     : "/list.val1/list.val2/list.val3",
        "{/keys}"      : "/key1,val1,key2,val2",
        "{/keys*}"     : "/key1/val1/key2/val2",
        "{/keys+}"     : "/keys.key1/val1/keys.key2/val2",
        //added own
        "{/undef}"     : "",

    //  Label expansion, dot-prefixed
        "X{.var}"     : "X.value",
        "X{.empty}"   : "X.",
        "X{.undef}"   : "X",
        "X{.list}"    : "X.val1,val2,val3",
        "X{.list*}"   : "X.val1.val2.val3",
        "X{.list*,x}" : "X.val1.val2.val3.1024",
        "X{.list+}"   : "X.list.val1.list.val2.list.val3",
        "X{.keys}"    : "X.key1,val1,key2,val2",
        "X{.keys*}"   : "X.key1.val1.key2.val2",
        "X{.keys+}"   : "X.keys.key1.val1.keys.key2.val2",
        //added own
        "{.undef}"     : ""
    };
    
    assertSet(testset, context);
});


test("page 11 on reserved operators", function() {
    /*
    from page 11: 
    The operator characters pipe ("|"), exclamation ("!"), and at-sign("@") are reserved for future extensions.
    A processor that unexpectedly encounters such an extension operator SHOULD pass the
    expression through unexpanded and MAY also indicate a warning to the invoking application.
    */
    var context = {
        "var" : "value"
    };

    var testset = {
        "{@var}"          : "{@var}",
        "{|var}"          : "{|var}",
        "{!var}"          : "{!var}"
    };
    
    assertSet(testset, context);
});


test("page 13", function() {
    var context = {
        "address"   : {"city": "Newport Beach", "state": "CA"},
        "from"      : {"zipcode": 92660}, 
        "to"        : {"zipcode": 90210}, 
    };

    var testset = {
        "/mapper{?address*}"       : "/mapper?city=Newport%20Beach&state=CA",
        "/directions{?from+,to+}"  : "/directions?from.zipcode=92660&to.zipcode=90210"
    };
    
    assertSet(testset, context);
});



test("page 15 on partial modifier", function() {
    var context = {
        "var"    : "value",
        "name"   : [ "Fred", "Wilma", "Pebbles" ]
    };

    var testset = {
        "{var}"     : "value",
        "{var:20}"  : "value",
        "{var:3}"   : "val",
        "{var^3}"   : "ue",
        "{var:-3}"  : "lue",
        "{var^-3}"  : "va",
        "{?name}"   : "?name=Fred,Wilma,Pebbles",
        "{?name:1}" : "?name=F"
    };
    
    assertSet(testset, context);
});



test("page 15-17 on defaults", function() {
    var context = {
        "var"        : "value",
        "empty"      : "",
        "undef"      : null,
        "name"       : [ "Fred", "Wilma", "Pebbles" ],
        "favs"       : {"color": "red", "volume": "high"},
        "empty_list" : [],
        "empty_keys" : {}
    };

    var testset = {
        "{var=default}"       : "value",
        "{undef=default}"     : "default",
        "x{empty}y"           : "xy",
        "x{empty=_}y"         : "xy",
        "x{undef}y"           : "xy",
        "x{undef=_}y"         : "x_y",
        "x{empty_list}y"      : "xy",
        "x{empty_list=_}y"    : "xy",
        "x{empty_list*}y"     : "xy",
        "x{empty_list*=_}y"   : "x_y",
        "x{empty_list+}y"     : "xy",
        "x{empty_list+=_}y"   : "xempty_list._y",
        "x{empty_keys}y"      : "xy",
        "x{empty_keys=_}y"    : "xy",
        "x{empty_keys*}y"     : "xy",
        "x{empty_keys*=_}y"   : "x_y",
        "x{empty_keys+}y"     : "xy",
        "x{empty_keys+=_}y"   : "xempty_keys._y",
        "x{?name=none}"       : "x?name=Fred,Wilma,Pebbles",
        "x{?favs=none}"       : "x?favs=color,red,volume,high",
        "x{?favs*=none}"      : "x?color=red&volume=high",
        "x{?favs+=none}"      : "x?favs.color=red&favs.volume=high",
        "x{?undef}"           : "x",
        "x{?undef=none}"      : "x?undef=none",
        "x{?empty}"           : "x?empty=",
        "x{?empty=none}"      : "x?empty=",
        "x{?empty_list}"      : "x",
        "x{?empty_list=none}" : "x?empty_list=none",
        "x{?empty_list*}"     : "x",
        "x{?empty_list*=none}": "x?none",
        "x{?empty_list+}"     : "x",
        "x{?empty_list+=none}": "x?empty_list.none",
        "x{?empty_keys}"      : "x",
        "x{?empty_keys=none}" : "x?empty_keys=none",
        "x{?empty_keys*}"     : "x",
        "x{?empty_keys*=none}": "x?none",
        "x{?empty_keys+}"     : "x",
        "x{?empty_keys+=none}": "x?empty_keys.none",
        "x{;name=none}"       : "x;name=Fred,Wilma,Pebbles",
        "x{;favs=none}"       : "x;favs=color,red,volume,high",
        "x{;favs*=none}"      : "x;color=red;volume=high",
        "x{;favs+=none}"      : "x;favs.color=red;favs.volume=high",
        "x{;undef}"           : "x",
        "x{;undef=none}"      : "x;undef=none",
        "x{;empty}"           : "x;empty",
        "x{;empty=none}"      : "x;empty",
        "x{;empty_list}"      : "x",
        "x{;empty_list=none}" : "x;empty_list=none",
        "x{;empty_list*}"     : "x",
        "x{;empty_list*=none}": "x;none",
        "x{;empty_list+}"     : "x",
        "x{;empty_list+=none}": "x;empty_list.none",
        "x{;empty_keys}"      : "x",
        "x{;empty_keys=none}" : "x;empty_keys=none",
        "x{;empty_keys*}"     : "x",
        "x{;empty_keys*=none}": "x;none",
        "x{;empty_keys+}"     : "x",
        "x{;empty_keys+=none}": "x;empty_keys.none",
        "x{/name=none}"       : "x/Fred,Wilma,Pebbles",
        "x{/name*=none}"      : "x/Fred/Wilma/Pebbles",
        "x{/name+=none}"      : "x/name.Fred/name.Wilma/name.Pebbles",
        "x{/favs=none}"       : "x/color,red,volume,high",
        "x{/favs*=none}"      : "x/color/red/volume/high",
        "x{/favs+=none}"      : "x/favs.color/red/favs.volume/high",
        "x{/undef}"           : "x",
        "x{/undef=none}"      : "x/none",
        "x{/empty}"           : "x/",
        "x{/empty=none}"      : "x/",
        "x{/empty_list}"      : "x",
        "x{/empty_list=none}" : "x/none",
        "x{/empty_list*}"     : "x",
        "x{/empty_list*=none}": "x/none",
        "x{/empty_list+}"     : "x",
        "x{/empty_list+=none}": "x/empty_list.none",
        "x{/empty_keys}"      : "x",
        "x{/empty_keys=none}" : "x/none",
        "x{/empty_keys*}"     : "x",
        "x{/empty_keys*=none}": "x/none",
        "x{/empty_keys+}"     : "x",
        "x{/empty_keys+=none}": "x/empty_keys.none"
    };
    
    assertSet(testset, context);
});




test("page 21 on simple expansion", function() {
    var context = {
        "foo"    : "fred"
    };

    var testset = {
        "{foo}"       : "fred",
        "{foo,foo}"   : "fred,fred",
        "{bar,foo}"   : "fred",
        "{bar=wilma}" : "wilma"
    };
    
    assertSet(testset, context);
});


test("page 21 on reserved expansion", function() {
    var context = {
        "foo"    : "That's right!",
        "base"   : "http://example.com/home/"
    };

    var testset = {
        "{foo}"         : "That%27s%20right%21",
        "{+foo}"        : "That%27s%20right!",
        "{base}index"   : "http%3A%2F%2Fexample.com%2Fhome%2Findex",
        "{+base}index"  : "http://example.com/home/index"
    };
    
    assertSet(testset, context);
});



module("Test incompleteness");
test("completion", function() {
    ok( false, "more tests still need to be coded!" );
    // context-variables that are functions!!!
    // test that using reserved operators throw exceptions @ expand OR @ parse? (fail fast?)
    // functional tests per operators, showing typical use cases
    // testing strange chars that need %encoding >> special care for partial stuff: first trim, then encode not to have 
    // tests with variables holding %HH sections (allowed)
});


    });
  </script>  
</head>
<body>
  <h1 id="qunit-header">QUnit tests for uri-templates</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
