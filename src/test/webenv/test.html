<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="./js/jquery-1.6.2.min.js"></script>
  <link rel="stylesheet" href="./qunit/qunit.css" type="text/css" media="screen" />
  <script type="text/javascript" src="./qunit/qunit.js"></script>
  <script type="text/javascript" src="../../main/js/uritemplates.js"></script>

  <script>
    $(document).ready( function() {
    
// pure parsing and object instantiation
module("Uri template parsing");

test("parse templates", function() {
    var tees = [
        "",
        "{x}",
        "{x.y}",
        "{+x}",
        "{+x*|help,y}",
        "{x+}",
        "{x:10}",
        "{x^-3|def}",
        "{a,b}",
        "{+a,b}",
        "{/a|yes,b|no}",
        "{?a:-2,b*}",
        "{.a,b}",
        "{;a,b^4}",
        "abc",
        "a{b}c",
        "{this}and{that}or{more}",
        "half{open",
        "half}close",
        "more{normal}open{half{whole}",
        "{whole}half}close{normal}more",
        "more{normal}{en{clos}ed}{normal}more"
    ];
    var cnt = tees.length;

    expect(cnt);
    
    for (var i = 0; i < cnt; i++) {
        try {
            var parsed = $.uritemplate(tees[i]);
            ok (parsed != null, "completed parsing of '" + tees[i] + "'");
        } catch (err) {
            var errStr = QUnit.jsDump.parse(err);
            ok (false, "error in parsing of '" + tees[i] + "' : " + errStr);
        }
    }
});

function assertSet(set, data) {
    
    var count = 0;
    for (pattern in set) {
        count++
    }
    expect(count);
    
    for (pattern in set) {
        var template = $.uritemplate(pattern);
        var result = template.expand(data);
        var expected = set[pattern];

        equals(result, expected, "tested pattern: " + pattern);
    }
}

module("Samples from draft 0.5");
test("Section 1.1 'overview'", function() {
    var context = {"username": "mpo", "term": "dog", "q": "cat", "lang": "en", "query": "mycelium", "number": 100};
    var testset = {
        "http://example.com/~{username}/"               : "http://example.com/~mpo/",
        "http://example.com/dictionary/{term:1}/{term}" : "http://example.com/dictionary/d/dog",
        "http://example.com/search{?q,lang}"            : "http://example.com/search?q=cat&lang=en",
        "http://www.example.com/foo{?query,number}"     : "http://www.example.com/foo?query=mycelium&number=100",
        "http://www.example.com/foo{?undef,number}"     : "http://www.example.com/foo?number=100",
        "http://www.example.com/foo{?undef,nodef}"      : "http://www.example.com/foo"
    };
    assertSet(testset, context);
});

test("Section 1.2 'levels and expression types' -- Level 1", function() {
    var context = {"var": "value", "hello": "Hello World!", "empty": "", "undef": null};
    var testset = {
        "{var}"                   : "value",
        "{hello}"                 : "Hello%20World%21",
        "O{empty}X"               : "OX",
        "O{undef}X"               : "OX"
    };
    assertSet(testset, context);
});

test("Section 1.2 'levels and expression types' -- Level 2", function() {
    var context = {"var": "value", "hello": "Hello World!", "empty": "", "undef": null, "path": "/foo/bar"};
    var testset = {
        "{var|default}"         : "value",
        "O{empty|default}X"     : "OX",
        "O{undef|default}X"     : "OdefaultX",
        "{+var}"                : "value",
        "{+hello}"              : "Hello%20World!",
        "{+path}/here"          : "/foo/bar/here",
        "here?ref={+path}"      : "here?ref=/foo/bar",
        "up{+path}{var}/here"     : "up/foo/barvalue/here",
        "up{+empty|/1}/here"    : "up/here",
        "up{+undef|/1}/here"    : "up/1/here"
    };
    assertSet(testset, context);
});


test("Section 1.2 'levels and expression types' -- Level 3", function() {
    var context = {"var": "value", "hello": "Hello World!", "empty": "", "undef": null, 
                   "path": "/foo/bar", "x": 1024, "y": "768"};
    var testset = {
        "{x,y}"                 : "1024,768",
        "{x,hello,y}"           : "1024,Hello%20World%21,768",
        "?{x,empty}"            : "?1024,",
        "?{x,undef}"            : "?1024",
        "?{undef,y}"            : "?768",
        "?{x,undef|0}"          : "?1024,0",
        "{+x,hello,y}"          : "1024,Hello%20World!,768",
        "{+path,x}/here"        : "/foo/bar,1024/here", 
        "X{.var}"               : "X.value",
        "X{.empty}"             : "X.",
        "X{.undef}"             : "X",
        "{/var}"                : "/value",
        "{/var,empty}"          : "/value/",
        "{/var,undef}"          : "/value",
        "{/var,x}/here"         : "/value/1024/here",
        "{;x,y}"                : ";x=1024;y=768",
        "{;x,y,empty}"          : ";x=1024;y=768;empty",
        "{;x,y,undef}"          : ";x=1024;y=768",
        "{?x,y}"                : "?x=1024&y=768",
        "{?x,y,empty}"          : "?x=1024&y=768&empty=",
        "{?x,y,undef}"          : "?x=1024&y=768"
    };
    
    assertSet(testset, context);
});


test("Section 1.2 'levels and expression types' -- Level 4", function() {
    var context = {"var": "value", "hello": "Hello World!", 
                   "path": "/foo/bar", 
                   "list": [ "red", "green", "blue" ],
                   "keys": {"semi": ";", "dot": ".", "comma": ","}  };
    var testset = {
        // String expansion with value modifiers         (Sec 3.2.2) |
        "{var:3}"               : "val",
        "{var:30}"              : "value",
        "{list}"                : "red,green,blue",
        "{list*}"               : "red,green,blue",
        "{keys}"                : "semi,%3B,dot,.,comma,%2C",
        "{keys*}"               : "semi=%3B,dot=.,comma=%2C",
        //Reserved expansion with value modifiers       (Sec 3.2.3) |
        "{+path:6}/here"        : "/foo/b/here",
        "{+list}"               : "red,green,blue",
        "{+list*}"              : "red,green,blue",
        "{+keys}"               : "semi,;,dot,.,comma,,",
        "{+keys*}"              : "semi=;,dot=.,comma=,",
        //Label expansion, dot-prefixed                 (Sec 3.2.4) |
        "X{.var:3}"             : "X.val",
        "X{.list}"              : "X.red,green,blue",
        "X{.list*}"             : "X.red.green.blue",
        "X{.keys}"              : "X.semi,%3B,dot,.,comma,%2C",
        "X{.keys*}"             : "X.semi=%3B.dot=..comma=%2C",
        //Path segments, slash-prefixed                 (Sec 3.2.5) |
        "{/var:1,var}"          : "/v/value",
        "{/list}"               : "/red,green,blue",
        "{/list*}"              : "/red/green/blue",
        "{/list*,path:4}"       : "/red/green/blue/%2Ffoo",
        "{/keys}"               : "/semi,%3B,dot,.,comma,%2C",
        "{/keys*}"              : "/semi=%3B/dot=./comma=%2C",
        //Path-style parameters, semicolon-prefixed     (Sec 3.2.6) |
        "{;hello:5}"            : ";hello=Hello",
        "{;list}"               : ";list=red,green,blue",
        "{;list*}"              : ";red;green;blue",
        "{;keys}"               : ";keys=semi,%3B,dot,.,comma,%2C",
        "{;keys*}"              : ";semi=%3B;dot=.;comma=%2C",
        //Form-style query, ampersand-separated         (Sec 3.2.7) |
        "{?var:3}"              : "?var=val",
        "{?list}"               : "?list=red,green,blue",
        "{?list*}"              : "?list=red&list=green&list=blue",
        "{?keys}"               : "?keys=semi,%3B,dot,.,comma,%2C",
        "{?keys*}"              : "?semi=%3B&dot=.&comma=%2C"
    };
    
    assertSet(testset, context);
});

test("Section 2.4.1 'prefix values'", function() {
    var context = {"var": "value", "semi": ";" };
    var testset = {
        "{var}"                 : "value",
        "{var:20}"              : "value",
        "{var:3}"               : "val",
        "{semi}"                : "%3B",
        "{semi:2}"              : "%3B"
    };
    
    assertSet(testset, context);
});
  

test("Section 2.5 'value defaults'", function() {
    var context = { "var" : "value", "name" : [ "Fred", "Wilma", "Pebbles" ], 
                    "favs": [("color","red"), ("volume","high")], 
                    "empty_keys" : [], "empty" : "", "undef" : null };
    var testset = {
        "{var|default}"         : "value",
        "{undef|default}"       : "default",
        "{undef:3|default}"     : "default",

        "x{empty}y"             : "xy",
        "x{empty|_}y"           : "xy",
        "x{undef}y"             : "xy",
        "x{undef|_}y"           : "x_y",

        "x{.name|none}"         : "x.Fred,Wilma,Pebbles",
        "x{.name*|none}"        : "x.Fred.Wilma.Pebbles",
        "x{.empty}"             : "x.",
        "x{.empty|none}"        : "x.",
        "x{.undef}"             : "x",
        "x{.undef|none}"        : "x.none",

        "x{/name|none}"         : "x/Fred,Wilma,Pebbles",
        "x{/name*|none}"        : "x/Fred/Wilma/Pebbles",
        "x{/undef}"             : "x",
        "x{/undef|none}"        : "x/none",
        "x{/empty}"             : "x/",
        "x{/empty|none}"        : "x/",
        "x{/empty_keys}"        : "x",
        "x{/empty_keys|none}"   : "x/none",
        "x{/empty_keys*}"       : "x",
        "x{/empty_keys*|none}"  : "x/none",

        "x{;name|none}"         : "x;name=Fred,Wilma,Pebbles",
        "x{;favs|none}"         : "x;favs=color,red,volume,high",
        "x{;favs*|none}"        : "x;color=red;volume=high",
        "x{;empty}"             : "x;empty",
        "x{;empty|none}"        : "x;empty",
        "x{;undef}"             : "x",
        "x{;undef|none}"        : "x;none",
        "x{;undef|foo=y}"       : "x;foo=y",

        "x{?var|none}"          : "x?var=value",
        "x{?favs|none}"         : "x?favs=color,red,volume,high",
        "x{?favs*|none}"        : "x?color=red&volume=high",
        "x{?empty}"             : "x?empty=",
        "x{?empty|foo=none}"    : "x?empty=",
        "x{?undef}"             : "x",
        "x{?undef|foo=none}"    : "x?foo=none",
        "x{?empty_keys}"        : "x",
        "x{?empty_keys|none}"   : "x?none",
        "x{?empty_keys|y=z}"    : "x?y=z",
        "x{?empty_keys*|y=z}"   : "x?y=z",
    };
    
    assertSet(testset, context);
});


test("Section 3.2.2 'simple string expansion'", function() {
    var context = {"foo": "fred" };
    var testset = {
        "{foo}"                 : "fred",
        "{foo,foo}"             : "fred,fred",
        "{bar,foo}"             : "fred",
        "{bar|wilma}"           : "wilma"
    };
    
    assertSet(testset, context);
});
  
  
test("Section 3.2.3 'reserved expansion'", function() {
    var context = {"foo": "That's right!", "base" : "http://example.com/home/" };
    var testset = {
        "{foo}"                 : "That%27s%20right%21",
        "{+foo}"                : "That%27s%20right!",
        "{base}index"           : "http%3A%2F%2Fexample.com%2Fhome%2Findex",
        "{+base}index"          : "http://example.com/home/index"
    };
    
    assertSet(testset, context);
});
    

test("Section 3.2.4 'label expansion'", function() {
    var context = {"foo": "fred" };
    var testset = {
        "{.foo}"                 : ".fred",
        "{.foo,foo}"             : ".fred.fred",
        "{.bar,foo}"             : ".fred",
        "{.bar|wilma}"           : ".wilma"
    };

    assertSet(testset, context);
});


test("Section 3.2.5 'path segment expansion'", function() {
    var context = {"foo": "fred" };
    var testset = {
        "{/foo}"                 : "/fred",
        "{/foo,foo}"             : "/fred/fred",
        "{/bar,foo}"             : "/fred",
        "{/bar|wilma}"           : "/wilma"
    };

    assertSet(testset, context);
});

   
test("Section 3.2.6 'matrix parameter expansion'", function() {
    var context = {"foo": "fred" };
    var testset = {
        "{;foo}"                 : ";foo=fred",
        "{;foo,foo}"             : ";foo=fred;foo=fred",
        "{;bar,foo}"             : ";foo=fred",
        "{;bar|wilma}"           : ";bar=wilma"
    };

    assertSet(testset, context);
});


test("Section 3.2.7 'form parameter expansion'", function() {
    var context = {"foo": "fred" };
    var testset = {
        "{?foo}"                 : "?foo=fred",
        "{?foo,foo}"             : "?foo=fred&foo=fred",
        "{?bar,foo}"             : "?foo=fred",
        "{?bar|wilma}"           : "?bar=wilma&foo=fred"
    };

    assertSet(testset, context);
});      



module("Samples from draft 0.4");
test("page 5", function() {
    var context = {"query": "mycelium", "number": 100}; // no "undef"
    var testset = {
        "http://www.example.com/foo{?query,number}": "http://www.example.com/foo?query=mycelium&number=100",
        "http://www.example.com/foo{?undef,number}": "http://www.example.com/foo?number=100"
    };
    assertSet(testset, context);
});

test("table on pages 6-8", function() {
    var context = {
        "var"   : "value",
        "hello" : "Hello World!",
        "undef" : null, //explicit, but same as not mentioning it
        "empty" : "",
        "list"  : [ "val1", "val2", "val3" ],
        "keys"  : {"key1": "val1", "key2": "val2"},
        "path"  : "/foo/bar",
        "x"     : 1024,
        "y"     : 768
    }



    var testset = {
    //  Simple expansion with comma-separated values
        "{var}"           : "value",
        "{hello}"          : "Hello%20World%21",
        "{path}/here"     : "%2Ffoo%2Fbar/here",
        "{x,y}"           : "1024,768",
        "{var|default}"   : "value",
        "{undef|default}" : "default",
        "{list}"          : "val1,val2,val3",
        "{list*}"         : "val1,val2,val3",
        "{list+}"         : "list.val1,list.val2,list.val3",
        "{keys}"          : "key1,val1,key2,val2",
        "{keys*}"         : "key1,val1,key2,val2",
        "{keys+}"         : "keys.key1,val1,keys.key2,val2",

    // Reserved expansion with comma-separated values
        "{+var}"         : "value",
        "{+hello}"       : "Hello%20World!",
        "{+path}/here"   : "/foo/bar/here",
        "{+path,x}/here" : "/foo/bar,1024/here",
        "{+path}{x}/here": "/foo/bar1024/here",
        "{+empty}/here"  : "/here",
        "{+undef}/here"  : "/here",
        "{+list}"        : "val1,val2,val3",
        "{+list*}"       : "val1,val2,val3",
        "{+list+}"       : "list.val1,list.val2,list.val3",
        "{+keys}"        : "key1,val1,key2,val2",
        "{+keys*}"       : "key1,val1,key2,val2",
        "{+keys+}"       : "keys.key1,val1,keys.key2,val2",

    // Path-style parameters, semicolon-prefixed
        "{;x,y}"       : ";x=1024;y=768",
        "{;x,y,empty}" : ";x=1024;y=768;empty",
        "{;x,y,undef}" : ";x=1024;y=768",
        "{;list}"      : ";val1,val2,val3",
        "{;list*}"     : ";val1;val2;val3",
        "{;list+}"     : ";list=val1;list=val2;list=val3",
        "{;keys}"      : ";key1,val1,key2,val2",
        "{;keys*}"     : ";key1=val1;key2=val2",
        "{;keys+}"     : ";keys.key1=val1;keys.key2=val2",


    //  Form-style parameters, ampersand-separated
        "{?x,y}"       : "?x=1024&y=768",
        "{?x,y,empty}" : "?x=1024&y=768&empty=",
        "{?x,y,undef}" : "?x=1024&y=768",
        "{?list}"      : "?list=val1,val2,val3",
        "{?list*}"     : "?val1&val2&val3",
        "{?list+}"     : "?list=val1&list=val2&list=val3",
        "{?keys}"      : "?keys=key1,val1,key2,val2",
        "{?keys*}"     : "?key1=val1&key2=val2",
        "{?keys+}"     : "?keys.key1=val1&keys.key2=val2",

    //  Hierarchical path segments, slash-separated
        "{/var}"       : "/value",
        "{/var,empty}" : "/value/",
        "{/var,undef}" : "/value",
        "{/list}"      : "/val1,val2,val3",
        "{/list*}"     : "/val1/val2/val3",
        "{/list*,x}"   : "/val1/val2/val3/1024",
        "{/list+}"     : "/list.val1/list.val2/list.val3",
        "{/keys}"      : "/key1,val1,key2,val2",
        "{/keys*}"     : "/key1/val1/key2/val2",
        "{/keys+}"     : "/keys.key1/val1/keys.key2/val2",

    //  Label expansion, dot-prefixed
        "X{.var}"     : "X.value",
        "X{.empty}"   : "X.",
        "X{.undef}"   : "X",
        "X{.list}"    : "X.val1,val2,val3",
        "X{.list*}"   : "X.val1.val2.val3",
        "X{.list*,x}" : "X.val1.val2.val3.1024",
        "X{.list+}"   : "X.list.val1.list.val2.list.val3",
        "X{.keys}"    : "X.key1,val1,key2,val2",
        "X{.keys*}"   : "X.key1.val1.key2.val2",
        "X{.keys+}"   : "X.keys.key1.val1.keys.key2.val2",
    };
    
    assertSet(testset, context);
});


test("page 11 on reserved operators", function() {
    /*
    from page 11: 
    The operator characters pipe ("|"), exclamation ("!"), and at-sign("@") are reserved for future extensions.
    A processor that unexpectedly encounters such an extension operator SHOULD pass the
    expression through unexpanded and MAY also indicate a warning to the invoking application.
    */
    var context = {
        "var" : "value"
    };

    var testset = {
        "{@var}"          : "{@var}",
        "{|var}"          : "{|var}",
        "{!var}"          : "{!var}"
    };
    
    assertSet(testset, context);
});


test("page 13", function() {
    var context = {
        "address"   : {"city": "Newport Beach", "state": "CA"},
        "from"      : {"zipcode": 92660}, 
        "to"        : {"zipcode": 90210}, 
    };

    var testset = {
        "/mapper{?address*}"       : "/mapper?city=Newport%20Beach&state=CA",
        "/directions{?from+,to+}"  : "/directions?from.zipcode=92660&to.zipcode=90210"
    };
    
    assertSet(testset, context);
});



test("page 15 on partial modifier", function() {
    var context = {
        "var"    : "value",
        "name"   : [ "Fred", "Wilma", "Pebbles" ]
    };

    var testset = {
        "{var}"     : "value",
        "{var:20}"  : "value",
        "{var:3}"   : "val",
        "{var^3}"   : "ue",
        "{var:-3}"  : "lue",
        "{var^-3}"  : "va",
        "{?name}"   : "?name=Fred,Wilma,Pebbles",
        "{?name:1}" : "?name=F"
    };
    
    assertSet(testset, context);
});



test("page 15-17 on defaults", function() {
    var context = {
        "var"        : "value",
        "empty"      : "",
        "undef"      : null,
        "name"       : [ "Fred", "Wilma", "Pebbles" ],
        "favs"       : {"color": "red", "volume": "high"},
        "empty_list" : [],
        "empty_keys" : {}
    };

    var testset = {
        "{var|default}"       : "value",
        "{undef|default}"     : "default",
        "x{empty}y"           : "xy",
        "x{empty|_}y"         : "xy",
        "x{undef}y"           : "xy",
        "x{undef|_}y"         : "x_y",
        "x{empty_list}y"      : "xy",
        "x{empty_list|_}y"    : "xy",
        "x{empty_list*}y"     : "xy",
        "x{empty_list*|_}y"   : "x_y",
        "x{empty_list+}y"     : "xy",
        "x{empty_list+|_}y"   : "xempty_list._y",
        "x{empty_keys}y"      : "xy",
        "x{empty_keys|_}y"    : "xy",
        "x{empty_keys*}y"     : "xy",
        "x{empty_keys*|_}y"   : "x_y",
        "x{empty_keys+}y"     : "xy",
        "x{empty_keys+|_}y"   : "xempty_keys._y",
        "x{?name|none}"       : "x?name=Fred,Wilma,Pebbles",
        "x{?favs|none}"       : "x?favs=color,red,volume,high",
        "x{?favs*|none}"      : "x?color=red&volume=high",
        "x{?favs+|none}"      : "x?favs.color=red&favs.volume=high",
        "x{?undef}"           : "x",
        "x{?undef|none}"      : "x?undef=none",
        "x{?empty}"           : "x?empty=",
        "x{?empty|none}"      : "x?empty=",
        "x{?empty_list}"      : "x",
        "x{?empty_list|none}" : "x?empty_list=none",
        "x{?empty_list*}"     : "x",
        "x{?empty_list*|none}": "x?none",
        "x{?empty_list+}"     : "x",
        "x{?empty_list+|none}": "x?empty_list.none",
        "x{?empty_keys}"      : "x",
        "x{?empty_keys|none}" : "x?empty_keys=none",
        "x{?empty_keys*}"     : "x",
        "x{?empty_keys*|none}": "x?none",
        "x{?empty_keys+}"     : "x",
        "x{?empty_keys+|none}": "x?empty_keys.none",
        "x{;name|none}"       : "x;name=Fred,Wilma,Pebbles",
        "x{;favs|none}"       : "x;favs=color,red,volume,high",
        "x{;favs*|none}"      : "x;color=red;volume=high",
        "x{;favs+|none}"      : "x;favs.color=red;favs.volume=high",
        "x{;undef}"           : "x",
        "x{;undef|none}"      : "x;undef=none",
        "x{;empty}"           : "x;empty",
        "x{;empty|none}"      : "x;empty",
        "x{;empty_list}"      : "x",
        "x{;empty_list|none}" : "x;empty_list=none",
        "x{;empty_list*}"     : "x",
        "x{;empty_list*|none}": "x;none",
        "x{;empty_list+}"     : "x",
        "x{;empty_list+|none}": "x;empty_list.none",
        "x{;empty_keys}"      : "x",
        "x{;empty_keys|none}" : "x;empty_keys=none",
        "x{;empty_keys*}"     : "x",
        "x{;empty_keys*|none}": "x;none",
        "x{;empty_keys+}"     : "x",
        "x{;empty_keys+|none}": "x;empty_keys.none",
        "x{/name|none}"       : "x/Fred,Wilma,Pebbles",
        "x{/name*|none}"      : "x/Fred/Wilma/Pebbles",
        "x{/name+|none}"      : "x/name.Fred/name.Wilma/name.Pebbles",
        "x{/favs|none}"       : "x/color,red,volume,high",
        "x{/favs*|none}"      : "x/color/red/volume/high",
        "x{/favs+|none}"      : "x/favs.color/red/favs.volume/high",
        "x{/undef}"           : "x",
        "x{/undef|none}"      : "x/none",
        "x{/empty}"           : "x/",
        "x{/empty|none}"      : "x/",
        "x{/empty_list}"      : "x",
        "x{/empty_list|none}" : "x/none",
        "x{/empty_list*}"     : "x",
        "x{/empty_list*|none}": "x/none",
        "x{/empty_list+}"     : "x",
        "x{/empty_list+|none}": "x/empty_list.none",
        "x{/empty_keys}"      : "x",
        "x{/empty_keys|none}" : "x/none",
        "x{/empty_keys*}"     : "x",
        "x{/empty_keys*|none}": "x/none",
        "x{/empty_keys+}"     : "x",
        "x{/empty_keys+|none}": "x/empty_keys.none",
        //added own - cases for . operator missing in spec?
        "x{.undef}"           : "x"
    };
    
    assertSet(testset, context);
});




test("page 21 on simple expansion", function() {
    var context = {
        "foo"    : "fred"
    };

    var testset = {
        "{foo}"       : "fred",
        "{foo,foo}"   : "fred,fred",
        "{bar,foo}"   : "fred",
        "{bar|wilma}" : "wilma"
    };
    
    assertSet(testset, context);
});


test("page 21 on reserved expansion", function() {
    var context = {
        "foo"    : "That's right!",
        "base"   : "http://example.com/home/"
    };

    var testset = {
        "{foo}"         : "That%27s%20right%21",
        "{+foo}"        : "That%27s%20right!",
        "{base}index"   : "http%3A%2F%2Fexample.com%2Fhome%2Findex",
        "{+base}index"  : "http://example.com/home/index"
    };
    
    assertSet(testset, context);
});

module("Extra: js implementation features");
    // context-variables that are functions!!!
test("evaluate functions from context.", function() {
    var cnt = 0;
    var context = {
        "fn"        : function() {return cnt++;}
    };

    var testset = {
        "{fn}"         : "0",
        "{fn},{fn}"    : "1,1"
    };
    
    assertSet(testset, context);
});

test("dereference nesting from context.", function() {
    var context = {
        "a.b"       : "value @ a.b",
        "x"         : { "y": "value @ y via x"}
    }

    var testset = {
        "{a.b}"       : "value @ a.b",
        "{x.y}"       : "value @ y via x"
    };
    
    assertSet(testset, context);
});

module("Extra: edge cases");
test("trimming escaped sequences", function() {
    var context = {
        "string"       : "!!!!!",
        "list"         : ["!","!","!","!","!"]
    }

    var testset = {
        "{string:1}"   : "%21",
        "{string:2}"   : "%21%21",
        "{string:3}"   : "%21%21%21",
        "{string:-3}"  : "%21%21%21",
        "{string:-2}"  : "%21%21",
        "{string:-1}"  : "%21",
        "{list:1}"     : "%21",
        "{list:2}"     : "%21,",
        "{list:3}"     : "%21,%21",
        "{list:-3}"    : "%21,%21",
        "{list:-2}"    : ",%21",
        "{list:-1}"    : "%21",
    };
    
    assertSet(testset, context);
});


test("%encoded context names", function() {

    var context = {
        "!":  "exclamation-mark",
        "%21": "enocded exclamation-mark"
    }

    var testset = {
        "{!}"   : "{!}",
        "{%21}" : "exclamation_mark"
    };
    
    assertSet(testset, context);
});

    });
  </script>  
</head>
<body>
  <h1 id="qunit-header">QUnit tests for uri-templates</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
